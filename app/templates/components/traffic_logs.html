{% extends "base.html" %}

{% block content %}
{% set is_upload = request.url.path == '/traffic-logs/upload' %}
<!-- 원격 조회 섹션 -->
<div id="tlRemoteSection" {% if is_upload %}style="display:none;"{% endif %}>
	<!-- 제어 헤더 -->
	<div class="box mb-4">
		<div class="level mb-4">
			<div class="level-left">
				<div class="level-item">
					<h3 class="title is-4 mb-0">트래픽 로그 조회</h3>
				</div>
			</div>
			<div class="level-right">
				<div class="level-item">
					<div class="buttons">
						<button class="button is-primary" id="tlLoadBtn">조회</button>
						<span id="tlStatus" class="tag is-light ml-2">대기</span>
					</div>
				</div>
			</div>
		</div>
		<p id="tlError" class="help is-danger" style="display:none;"></p>

		<div class="columns is-vcentered">
			<div class="column is-3">
				<div class="field">
					<label class="label">프록시</label>
					<div class="control">
						<div class="select is-fullwidth">
							<select id="tlProxySelect">
								<option value="">프록시 선택</option>
							</select>
						</div>
					</div>
				</div>
			</div>
			<div class="column is-3">
				<div class="field">
					<label class="label">검색어 (고정문자열)</label>
					<input class="input" id="tlQuery" maxlength="256" placeholder="예: login">
				</div>
			</div>
			<div class="column is-2">
				<div class="field">
					<label class="label">라인 제한</label>
					<input class="input" id="tlLimit" type="number" min="1" max="1000" value="200">
				</div>
			</div>
			<div class="column is-2">
				<div class="field">
					<label class="label">방향</label>
					<div class="select is-fullwidth">
						<select id="tlDirection">
							<option value="tail" selected>tail</option>
							<option value="head">head</option>
						</select>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- 결과 섹션 -->
	<div id="tlResultRaw" class="box mb-4" style="display:none;">
		<h4 class="title is-5 mb-4">원시 로그</h4>
		<pre id="tlRawPre"></pre>
	</div>

	<div id="tlEmptyState" class="box empty-state mb-4" style="display:none;">
		표시할 로그가 없습니다. 상단에서 옵션을 설정하고 "조회"를 클릭하세요.
	</div>

	<div id="tlResultParsed" class="box" style="display:none;">
		<div class="level mb-4">
			<div class="level-left">
				<div class="level-item">
					<h4 class="title is-5 mb-0">파싱된 로그</h4>
				</div>
			</div>
			<div class="level-right">
				<div class="level-item">
					<div class="field has-addons">
						<div class="control">
							<input class="input is-small" type="text" id="tlQuickFilter" placeholder="전체 검색..." style="width: 200px;">
						</div>
						<div class="control">
							<button class="button is-small" id="tlClearFilters" title="모든 필터 삭제">
								<span>필터 초기화</span>
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="sb-table-wrap" style="height: 1200px;">
			<div id="tlTableGrid" style="height: 100%; width: 100%;"></div>
		</div>
	</div>
</div> <!-- /#tlRemoteSection -->

<!-- 업로드 분석 섹션 -->
<div id="tlaSection" {% if not is_upload %}style="display:none;"{% endif %}>
	<!-- 제어 헤더 -->
	<div class="box mb-4">
		<div class="level mb-4">
			<div class="level-left">
				<div class="level-item">
					<h3 class="title is-4 mb-0">트래픽 로그 분석</h3>
				</div>
			</div>
			<div class="level-right">
				<div class="level-item">
					<div class="buttons">
						<button class="button is-primary" id="tlaAnalyzeBtn">통계 분석</button>
						<span id="tlaStatus" class="tag is-light ml-2">대기</span>
					</div>
				</div>
			</div>
		</div>
		<p id="tlaError" class="help is-danger" style="display:none;"></p>

		<div class="columns is-vcentered">
			<div class="column is-7">
				<div class="field">
					<label class="label">로그 파일</label>
					<div class="file has-name is-fullwidth" id="tlaFileWrap">
						<label class="file-label">
							<input class="file-input" type="file" id="tlaFile" accept=".log,text/plain">
							<span class="file-cta">
								<span class="file-icon"><i class="fas fa-upload"></i></span>
								<span class="file-label">로그 파일 선택…</span>
							</span>
							<span class="file-name" id="tlaFileName">선택된 파일 없음</span>
						</label>
					</div>
				</div>
			</div>
			<div class="column is-2">
				<div class="field">
					<label class="label">Top N</label>
					<input class="input" type="number" id="tlaTopN" min="1" max="100" value="20">
				</div>
			</div>
		</div>
	</div>

	<!-- 요약 섹션 -->
	<div id="tlaSummary" style="display:none;">
		<div class="box mb-4">
			<h4 class="title is-5 mb-4">분석 요약</h4>
			<div class="columns is-multiline">
				<div class="column is-2"><div class="box has-text-centered"><p class="heading">총 라인</p><p class="title is-5" id="tlaTotalLines">0</p></div></div>
				<div class="column is-2"><div class="box has-text-centered"><p class="heading">파싱 성공</p><p class="title is-5" id="tlaParsed">0</p></div></div>
				<div class="column is-2"><div class="box has-text-centered"><p class="heading">파싱 실패</p><p class="title is-5" id="tlaUnparsed">0</p></div></div>
				<div class="column is-2"><div class="box has-text-centered"><p class="heading">클라이언트 수</p><p class="title is-5" id="tlaClients">0</p></div></div>
				<div class="column is-2"><div class="box has-text-centered"><p class="heading">호스트 수</p><p class="title is-5" id="tlaHosts">0</p></div></div>
				<div class="column is-2"><div class="box has-text-centered"><p class="heading">차단 로그 수</p><p class="title is-5" id="tlaBlocked">0</p></div></div>
				<div class="column is-3"><div class="box has-text-centered"><p class="heading">받은 데이터</p><p class="title is-6" id="tlaRecv">0</p></div></div>
				<div class="column is-3"><div class="box has-text-centered"><p class="heading">보낸 데이터</p><p class="title is-6" id="tlaSent">0</p></div></div>
				<div class="column is-3"><div class="box has-text-centered"><p class="heading">로그 시작 시간</p><p class="title is-6" id="tlaTimeStart">-</p></div></div>
				<div class="column is-3"><div class="box has-text-centered"><p class="heading">로그 종료 시간</p><p class="title is-6" id="tlaTimeEnd">-</p></div></div>
			</div>
		</div>
	</div>

	<!-- 파싱된 로그 그리드 섹션 -->
	<div id="tlaGridWrap" class="box mb-4" style="display:none;">
		<div class="level mb-4">
			<div class="level-left">
				<div class="level-item">
					<h4 class="title is-5 mb-0">파싱된 로그</h4>
				</div>
			</div>
			<div class="level-right">
				<div class="level-item">
					<div class="field has-addons">
						<div class="control">
							<input class="input is-small" type="text" id="tlaQuickFilter" placeholder="전체 검색..." style="width: 200px;">
						</div>
						<div class="control">
							<button class="button is-small" id="tlaClearFilters" title="모든 필터 삭제">
								<span>필터 초기화</span>
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="sb-table-wrap" style="height: 1200px;">
			<div id="tlaTableGrid" style="height: 100%; width: 100%;"></div>
		</div>
	</div>
	
	<div id="tlaEmptyState" class="box empty-state mb-4" style="display:none;">
		표시할 로그가 없습니다. 파일을 선택하고 "통계 분석" 버튼을 클릭하세요.
	</div>

	<!-- 차트 섹션 -->
	<div id="tlaCharts" style="display:none;">
		<div class="box">
			<h4 class="title is-5 mb-4">분석 차트</h4>
			<p class="mb-4 has-text-grey is-size-7">차트 막대를 클릭하면 항목 라벨(호스트/클라이언트)을 복사합니다.</p>
			<div class="columns">
				<div class="column is-6"><div class="box"><h5 class="title is-6">요청 상위 클라이언트</h5><div id="tlaChartClientReq"></div></div></div>
				<div class="column is-6"><div class="box"><h5 class="title is-6">요청 상위 호스트</h5><div id="tlaChartHosts"></div></div></div>
			</div>
			<div class="columns">
				<div class="column is-6"><div class="box"><h5 class="title is-6">받은 데이터 상위 클라이언트</h5><div id="tlaChartClientDown"></div></div></div>
				<div class="column is-6"><div class="box"><h5 class="title is-6">보낸 데이터 상위 클라이언트</h5><div id="tlaChartClientUp"></div></div></div>
			</div>
			<div class="columns">
				<div class="column is-6"><div class="box"><h5 class="title is-6">받은 데이터 상위 호스트</h5><div id="tlaChartHostDown"></div></div></div>
				<div class="column is-6"><div class="box"><h5 class="title is-6">보낸 데이터 상위 호스트</h5><div id="tlaChartHostUp"></div></div></div>
			</div>
		</div>
	</div>
</div> <!-- /#tlaSection -->

<!-- ag-grid (local) -->
<link rel="stylesheet" href="/static/vendor/ag-grid/ag-grid.css?v={{ request.app.version }}">
<link rel="stylesheet" href="/static/vendor/ag-grid/ag-theme-quartz.css?v={{ request.app.version }}">
<script src="/static/vendor/ag-grid/ag-grid-community.js?v={{ request.app.version }}"></script>
<!-- ApexCharts (local) -->
<script src="/static/vendor/apexcharts/apexcharts.min.js?v={{ request.app.version }}"></script>

<script src="/static/js/ag_grid_config.js?v={{ request.app.version }}"></script>
<script src="/static/js/traffic_logs.js?v={{ request.app.version }}"></script>
<script src="/static/js/traffic_logs_analyze.js?v={{ request.app.version }}"></script>

<!-- 상세 모달 -->
<div class="modal" id="tlDetailModal">
	<div class="modal-background"></div>
	<div class="modal-card is-wide">
		<header class="modal-card-head">
			<p class="modal-card-title">로그 상세</p>
			<button class="delete" aria-label="close" onclick="(function(){ $('#tlDetailModal').removeClass('is-active'); })()"></button>
		</header>
		<section class="modal-card-body">
			<div class="content">
				<table class="table is-fullwidth is-striped is-narrow">
					<tbody id="tlDetailBody"></tbody>
				</table>
			</div>
		</section>
		<footer class="modal-card-foot">
			<button class="button" onclick="(function(){ $('#tlDetailModal').removeClass('is-active'); })()">닫기</button>
		</footer>
	</div>
</div>

{% endblock %}

