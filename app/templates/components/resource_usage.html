{% extends "base.html" %}

{% block content %}
<div class="tabs is-boxed mb-4">
    <ul>
        <li class="is-active" data-tab="realtime">
            <a>실시간 모니터링</a>
        </li>
        <li data-tab="history">
            <a>이력 조회</a>
        </li>
    </ul>
</div>

<div id="realtime-tab" class="tab-content">
<!-- 필터/설정 섹션 -->
<div class="box mb-4">
    <div class="level mb-4">
        <div class="level-left">
            <div class="level-item">
                <h3 class="title is-4 mb-0">자원사용률 모니터링</h3>
            </div>
        </div>
        <div class="level-right">
            <div class="level-item">
                <div class="field has-addons">
                    <p class="control">
                        <span class="button is-static">주기(초)</span>
                    </p>
                    <p class="control">
                        <input class="input" id="ruIntervalSec" type="number" min="5" step="1" value="60">
                    </p>
                </div>
            </div>
            <div class="level-item">
                <div class="buttons">
                    <button class="button is-primary" id="ruStartBtn">시작</button>
                    <button class="button is-danger" id="ruStopBtn" disabled>중지</button>
                    <span id="ruStatus" class="tag is-light ml-2">정지됨</span>
                </div>
            </div>
        </div>
    </div>
    <p id="ruError" class="help is-danger" style="display:none;"></p>

    <div class="columns is-multiline">
        <div class="column is-2">
            <div class="field">
                <label class="label">그룹</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id="ruGroupSelect">
                            <option value="">전체</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="column is-10">
            <div class="field">
                <div class="level mb-3">
                    <div class="level-left">
                        <div class="level-item">
                            <label class="label mb-0">프록시 선택</label>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            <label class="checkbox">
                                <input type="checkbox" id="ruSelectAll"> 모두 선택
                            </label>
                        </div>
                    </div>
                </div>
                <div class="control">
                    <select id="ruProxySelect" multiple class="ts-fullwidth"></select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 히트맵 섹션 -->
<div class="box mb-4">
    <h4 class="title is-5 mb-4">자원 사용률 히트맵</h4>
    <div id="ruHeatmapWrap" style="overflow-x: auto; overflow-y: hidden;">
        <div id="ruHeatmapEl" style="min-width: 800px;"></div>
    </div>
    <div id="ruEmptyState" class="empty-state" style="display:none; padding: 2rem;">
        현재 표시할 데이터가 없습니다. 상단에서 대상을 선택하고 "시작"을 클릭하세요.
    </div>
</div>

<!-- 실시간 그래프 섹션 -->
<div class="box">
    <h4 class="title is-5 mb-4">실시간 그래프</h4>
    <div id="ruChartsWrap" class="columns is-multiline" data-initialized="false">
        <!-- Charts will be injected per metric by resource_usage.js -->
    </div>
</div>

<!-- Optional local Chart.js (place chart.umd.js under static/vendor/chartjs/) -->
<!-- Chart.js removed; using ApexCharts only -->
<!-- Local ApexCharts (MIT) for heatmap -->
<script src="/static/vendor/apexcharts/apexcharts.min.js"></script>
<script src="/static/js/resource_usage.js"></script>

<div class="modal" id="ruChartModal">
    <div class="modal-background"></div>
    <div class="modal-card" style="width: 90%; max-width: 1200px;">
        <header class="modal-card-head">
            <p class="modal-card-title" id="ruModalTitle"></p>
            <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
            <div id="ruModalChart"></div>
        </section>
    </div>
</div>
</div>

<div id="history-tab" class="tab-content" style="display:none;">
<!-- 조회 조건 섹션 -->
<div class="box mb-4">
    <div class="level mb-4">
        <div class="level-left">
            <div class="level-item">
                <h3 class="title is-4 mb-0">자원사용률 이력 조회</h3>
            </div>
        </div>
    </div>
    
    <div class="columns is-multiline">
        <div class="column is-3">
            <div class="field">
                <label class="label">프록시 선택</label>
                <div class="control">
                    <select id="ruHistoryProxySelect" class="ts-fullwidth">
                        <option value="">전체</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="column is-3">
            <div class="field">
                <label class="label">시작 시간</label>
                <div class="control">
                    <input class="input" id="ruHistoryStartTime" type="datetime-local">
                </div>
            </div>
        </div>
        <div class="column is-3">
            <div class="field">
                <label class="label">종료 시간</label>
                <div class="control">
                    <input class="input" id="ruHistoryEndTime" type="datetime-local">
                </div>
            </div>
        </div>
        <div class="column is-3">
            <div class="field">
                <label class="label">최대 조회 개수</label>
                <div class="control">
                    <input class="input" id="ruHistoryLimit" type="number" min="1" max="10000" value="1000">
                </div>
            </div>
        </div>
    </div>
    <div class="level">
        <div class="level-left"></div>
        <div class="level-right">
            <div class="level-item">
                <button class="button is-primary" id="ruHistorySearchBtn">조회</button>
            </div>
        </div>
    </div>
    
    <div id="ruHistoryLoading" class="has-text-centered mt-4" style="display:none;">
        <p class="help">조회 중...</p>
    </div>
    
    <div id="ruHistoryError" class="help is-danger mt-4" style="display:none;"></div>
</div>

<!-- 결과 섹션 -->
<div id="ruHistoryResults" style="display:none;">
    <div class="box mb-4">
        <h4 class="title is-5 mb-4">조회 결과</h4>
        <p id="ruHistoryCount" class="help mb-4"></p>
        <div class="table-container" style="max-height: 600px; overflow-y: auto;">
            <table class="table is-striped is-fullwidth is-hoverable">
                <thead>
                    <tr>
                        <th>수집 시간</th>
                        <th>프록시</th>
                        <th>CPU (%)</th>
                        <th>MEM (%)</th>
                        <th>CC</th>
                        <th>CS</th>
                        <th>HTTP</th>
                        <th>HTTPS</th>
                        <th>FTP</th>
                        <th>인터페이스 MBPS</th>
                    </tr>
                </thead>
                <tbody id="ruHistoryTableBody">
                </tbody>
            </table>
        </div>
    </div>
    
    <div id="ruHistoryChartWrap" class="box" style="display:none;">
        <h4 class="title is-5 mb-4">이력 그래프</h4>
        <div id="ruHistoryChart" style="width:100%; height:400px;"></div>
    </div>
</div>
</div>

<script>
// 탭 전환 기능
$(document).ready(function() {
    // 탭 클릭 이벤트 핸들러
    function switchTab(tabName) {
        // 모든 탭 비활성화
        $('.tabs li').removeClass('is-active');
        // 모든 탭 콘텐츠 숨기기
        $('.tab-content').hide();
        
        // 선택된 탭 활성화
        $('.tabs li[data-tab="' + tabName + '"]').addClass('is-active');
        // 선택된 탭 콘텐츠 표시
        $('#' + tabName + '-tab').show();
    }
    
    // 탭 클릭 이벤트 바인딩
    $('.tabs li').on('click', function(e) {
        e.preventDefault();
        const tab = $(this).data('tab');
        switchTab(tab);
    });
    
    // URL 파라미터로 탭 전환 (예: /resource?tab=history)
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    if (tabParam === 'history') {
        switchTab('history');
    } else {
        // 기본값: 실시간 모니터링 탭 표시
        switchTab('realtime');
    }
});
</script>
<script src="/static/js/resource_history.js"></script>
{% endblock %}

