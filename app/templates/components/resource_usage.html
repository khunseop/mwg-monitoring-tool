{% extends "base.html" %}

{% block content %}
<div class="tabs is-boxed mb-0">
    <ul>
        <li class="is-active" data-tab="realtime">
            <a>실시간 모니터링</a>
        </li>
        <li data-tab="history">
            <a>이력 조회</a>
        </li>
    </ul>
</div>

<div id="realtime-tab" class="tab-content">
<!-- 필터/설정 섹션 -->
<div class="box mb-4">
    <div class="level mb-4">
        <div class="level-left">
            <div class="level-item">
                <h3 class="title is-4 mb-0">자원사용률 모니터링</h3>
            </div>
        </div>
        <div class="level-right">
            <div class="level-item">
                <div class="field has-addons">
                    <p class="control">
                        <span class="button is-static">주기(초)</span>
                    </p>
                    <p class="control">
                        <input class="input" id="ruIntervalSec" type="number" min="5" step="1" value="60">
                    </p>
                </div>
            </div>
            <div class="level-item">
                <div class="buttons">
                    <button class="button is-primary" id="ruStartBtn">시작</button>
                    <button class="button is-danger" id="ruStopBtn" disabled>중지</button>
                    <span id="ruStatus" class="tag is-light ml-2">정지됨</span>
                </div>
            </div>
        </div>
    </div>
    <p id="ruError" class="help is-danger" style="display:none;"></p>

    <!-- 통합 필터바 -->
    <div class="filter-bar">
        <div class="filter-bar-content">
            <div class="filter-item">
                <span class="filter-label">그룹</span>
                <div class="filter-control">
                    <div class="select is-fullwidth">
                        <select id="ruGroupSelect">
                            <option value="">전체</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="filter-item filter-item-expanded">
                <span class="filter-label">프록시</span>
                <div class="filter-control">
                    <select id="ruProxySelect" multiple class="ts-fullwidth"></select>
                </div>
            </div>
            <div class="filter-item filter-item-checkbox">
                <label class="checkbox">
                    <input type="checkbox" id="ruSelectAll"> 모두 선택
                </label>
            </div>
        </div>
    </div>
</div>

<!-- 히트맵 섹션 -->
<div class="box mb-4">
    <h4 class="title is-5 mb-4">자원 사용률 히트맵</h4>
    <div id="ruHeatmapWrap" style="overflow-x: auto; overflow-y: auto; max-height: 80vh;">
        <div id="ruHeatmapEl" style="min-width: 800px;"></div>
    </div>
    <div id="ruEmptyState" class="empty-state" style="display:none; padding: 2rem;">
        현재 표시할 데이터가 없습니다. 상단에서 대상을 선택하고 "시작"을 클릭하세요.
    </div>
</div>

<!-- 실시간 그래프 섹션 -->
<div class="box">
    <h4 class="title is-5 mb-4">실시간 그래프</h4>
    <div id="ruChartsWrap" class="columns is-multiline" data-initialized="false">
        <!-- Charts will be injected per metric by resource_usage.js -->
    </div>
</div>

<!-- Optional local Chart.js (place chart.umd.js under static/vendor/chartjs/) -->
<!-- Chart.js removed; using ApexCharts only -->
<!-- Local ApexCharts (MIT) for heatmap -->
<script src="/static/vendor/apexcharts/apexcharts.min.js"></script>
<!-- Resource Usage 모듈들 (의존성 순서대로 로드) -->
<script src="/static/js/resource_usage_utils.js"></script>
<script src="/static/js/resource_usage_state.js"></script>
<script src="/static/js/resource_usage_heatmap.js"></script>
<script src="/static/js/resource_usage_charts.js"></script>
<script src="/static/js/resource_usage_polling.js"></script>
<script src="/static/js/resource_usage.js"></script>

<div class="modal" id="ruChartModal">
    <div class="modal-background"></div>
    <div class="modal-card" style="width: 90%; max-width: 1200px;">
        <header class="modal-card-head">
            <p class="modal-card-title" id="ruModalTitle"></p>
            <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
            <div id="ruModalChart"></div>
        </section>
    </div>
</div>
</div>

<div id="history-tab" class="tab-content" style="display:none;">
<!-- 조회 조건 섹션 -->
<div class="box mb-4">
    <div class="level mb-4">
        <div class="level-left">
            <div class="level-item">
                <h3 class="title is-4 mb-0">자원사용률 이력 조회</h3>
            </div>
        </div>
        <div class="level-right">
            <div class="level-item">
                <div class="tags">
                    <span class="tag is-info">총 레코드</span>
                    <span class="tag" id="ruHistoryTotalCount">-</span>
                    <span class="tag is-info">보관 기간</span>
                    <span class="tag">90일</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="columns is-multiline is-vcentered">
        <div class="column is-2">
            <div class="field">
                <label class="label">프록시 선택</label>
                <div class="control">
                    <select id="ruHistoryProxySelect" class="ts-fullwidth">
                        <option value="">전체</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="column is-2">
            <div class="field">
                <label class="label">시작 시간</label>
                <div class="control">
                    <input class="input" id="ruHistoryStartTime" type="datetime-local" placeholder="선택사항">
                </div>
            </div>
        </div>
        <div class="column is-2">
            <div class="field">
                <label class="label">종료 시간</label>
                <div class="control">
                    <input class="input" id="ruHistoryEndTime" type="datetime-local" placeholder="선택사항">
                </div>
            </div>
        </div>
        <div class="column is-2">
            <div class="field">
                <label class="label">페이지당 개수</label>
                <div class="control">
                    <select class="input" id="ruHistoryLimit">
                        <option value="100">100</option>
                        <option value="500" selected>500</option>
                        <option value="1000">1,000</option>
                        <option value="5000">5,000</option>
                        <option value="10000">10,000</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="column is-4">
            <div class="field">
                <label class="label">&nbsp;</label>
                <div class="control">
                    <div class="buttons">
                        <button class="button is-primary" id="ruHistorySearchBtn">기간 조회</button>
                        <button class="button is-info" id="ruHistoryLoadAllBtn">전체 조회</button>
                        <button class="button is-success" id="ruHistoryExportBtn">내보내기</button>
                        <button class="button is-danger" id="ruHistoryDeleteBtn">삭제</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="ruHistoryStatsDetails" class="content is-small mt-3" style="display:none;">
        <p id="ruHistoryStatsText" class="help"></p>
    </div>
    
    <div class="help mt-3">
        ※ 로그는 90일 이상 된 데이터가 자동으로 삭제됩니다.
    </div>
</div>
    
    <div id="ruHistoryLoading" class="has-text-centered mt-4" style="display:none;">
        <p class="help">조회 중...</p>
    </div>
    
    <div id="ruHistoryError" class="help is-danger mt-4" style="display:none;"></div>
</div>

<!-- 삭제 모달 -->
<div class="modal" id="ruHistoryDeleteModal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">로그 삭제</p>
            <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">삭제 옵션 선택</label>
                <div class="control">
                    <label class="radio">
                        <input type="radio" name="deleteOption" value="older" checked>
                        특정 기간 이상 된 데이터 삭제
                    </label>
                    <label class="radio">
                        <input type="radio" name="deleteOption" value="range">
                        기간 지정 삭제
                    </label>
                    <label class="radio">
                        <input type="radio" name="deleteOption" value="all">
                        전체 삭제 (위험)
                    </label>
                </div>
            </div>
            <div id="ruDeleteOlderThan" class="field">
                <label class="label">삭제할 기간 (일)</label>
                <div class="control">
                    <input class="input" type="number" id="ruDeleteOlderDays" min="1" value="90" placeholder="90">
                </div>
                <p class="help">이 기간 이상 된 데이터가 삭제됩니다.</p>
            </div>
            <div id="ruDeleteRange" class="field" style="display:none;">
                <div class="columns">
                    <div class="column">
                        <label class="label">시작 시간</label>
                        <input class="input" type="datetime-local" id="ruDeleteStartTime">
                    </div>
                    <div class="column">
                        <label class="label">종료 시간</label>
                        <input class="input" type="datetime-local" id="ruDeleteEndTime">
                    </div>
                </div>
            </div>
            <div class="field">
                <label class="label">프록시 선택 (선택사항)</label>
                <div class="control">
                    <select id="ruDeleteProxySelect" class="ts-fullwidth">
                        <option value="">전체</option>
                    </select>
                </div>
            </div>
            <div class="notification is-warning">
                <strong>경고:</strong> 삭제된 데이터는 복구할 수 없습니다.
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-danger" id="ruHistoryDeleteConfirmBtn">삭제</button>
            <button class="button" id="ruHistoryDeleteCancelBtn">취소</button>
        </footer>
    </div>
</div>

<!-- 결과 섹션 -->
<div id="ruHistoryResults" style="display:none;">
    <div class="box">
        <div class="level mb-4">
            <div class="level-left">
                <div class="level-item">
                    <h4 class="title is-5 mb-0">조회 결과</h4>
                </div>
                <div class="level-item">
                    <p id="ruHistoryCount" class="help mb-0 ml-3"></p>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <div class="pagination-info" id="ruHistoryPaginationInfo"></div>
                </div>
            </div>
        </div>
        <div id="ruHistoryTableGrid" style="height: 70vh; width: 100%;"></div>
        <nav class="pagination is-centered mt-4" role="navigation" id="ruHistoryPagination" style="display:none;">
            <a class="pagination-previous" id="ruHistoryPrevBtn">이전</a>
            <a class="pagination-next" id="ruHistoryNextBtn">다음</a>
            <ul class="pagination-list"></ul>
        </nav>
    </div>
</div>
</div>

<script>
// 탭 전환 기능
$(document).ready(function() {
    // 탭 클릭 이벤트 핸들러
    function switchTab(tabName) {
        // 모든 탭 비활성화
        $('.tabs li').removeClass('is-active');
        // 모든 탭 콘텐츠 숨기기
        $('.tab-content').hide();
        
        // 선택된 탭 활성화
        $('.tabs li[data-tab="' + tabName + '"]').addClass('is-active');
        // 선택된 탭 콘텐츠 표시
        $('#' + tabName + '-tab').show();
    }
    
    // 탭 클릭 이벤트 바인딩
    $('.tabs li').on('click', function(e) {
        e.preventDefault();
        const tab = $(this).data('tab');
        switchTab(tab);
    });
    
    // URL 파라미터로 탭 전환 (예: /resource?tab=history)
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    if (tabParam === 'history') {
        switchTab('history');
    } else {
        // 기본값: 실시간 모니터링 탭 표시
        switchTab('realtime');
    }
});
</script>
<!-- ag-grid (local) -->
<link rel="stylesheet" href="/static/vendor/ag-grid/ag-grid.css?v={{ request.app.version }}">
<link rel="stylesheet" href="/static/vendor/ag-grid/ag-theme-quartz.css?v={{ request.app.version }}">
<script src="/static/vendor/ag-grid/ag-grid-community.js?v={{ request.app.version }}"></script>
<script src="/static/js/ag_grid_config.js"></script>
<script src="/static/js/resource_history.js"></script>
{% endblock %}

